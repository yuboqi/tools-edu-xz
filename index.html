<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“è‚²å·¥å…·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ğŸƒâ€â™‚ï¸ ä½“è‚²å·¥å…·ç³»ç»Ÿ</a>
            <div class="nav-menu">
                <a href="index.html?scoring" class="nav-item" id="nav-scoring">å¼¯é“è·‘è®¡åˆ†</a>
                <a href="index.html?compare" class="nav-item" id="nav-compare">ä½“æµ‹æ•°æ®å¯¹æ¯”</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»é¡µæ¬¢è¿ç•Œé¢ -->
    <div id="home-page" class="home-container" style="display: none;">
        <header class="home-header">
            <h1>ğŸƒâ€â™‚ï¸ ä½“è‚²å·¥å…·ç³»ç»Ÿ</h1>
            <p class="subtitle">ä¸ºå°å¼ æœåŠ¡çš„ä½“è‚²æ¯”èµ›ä¸æ•°æ®ç®¡ç†å·¥å…·é›†</p>
        </header>
        <div class="tool-cards">
            <div class="tool-card" onclick="window.location.href='index.html?scoring'">
                <div class="tool-icon">ğŸƒâ€â™‚ï¸</div>
                <h3>å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ</h3>
                <p>ç®€å•ã€å‡†ç¡®ã€æ˜“ç”¨çš„æ¯”èµ›è®¡åˆ†å·¥å…·</p>
                <button class="btn btn-primary">å¼€å§‹ä½¿ç”¨</button>
            </div>
            <div class="tool-card" onclick="window.location.href='index.html?compare'">
                <div class="tool-icon">ğŸ“Š</div>
                <h3>ä½“æµ‹æ•°æ®å¯¹æ¯”</h3>
                <p>å¯è§†åŒ–ä½“æµ‹æ•°æ®å¯¹æ¯”åˆ†æå·¥å…·</p>
                <button class="btn btn-primary">å¼€å§‹ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ -->
    <div id="scoring-page" class="container" style="display: none;">
        <header>
            <h1>ğŸƒâ€â™‚ï¸ å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ</h1>
            <p class="subtitle">ç®€å•ã€å‡†ç¡®ã€æ˜“ç”¨çš„æ¯”èµ›è®¡åˆ†å·¥å…·</p>
        </header>

        <!-- æ€»åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
        <section class="scoreboard">
            <h2>ğŸ“Š æ€»åˆ†æ’è¡Œæ¦œ</h2>
            <div id="totalScores" class="score-grid">
                <!-- åŠ¨æ€ç”Ÿæˆæ€»åˆ†æ˜¾ç¤º -->
            </div>
        </section>

        <!-- å½“å‰è½®æ¬¡åŒºåŸŸ -->
        <section class="current-round">
            <h2 id="roundTitle">å‡†å¤‡å¼€å§‹ç¬¬1è½®æ¯”èµ›</h2>
            <div id="currentRoundContent" class="round-content">
                <p class="round-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ–°ä¸€è½®æ¯”èµ›</p>
            </div>
        </section>

        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <section class="controls">
            <div class="button-group">
                <button id="startRoundBtn" class="btn btn-primary">å¼€å§‹æ–°ä¸€è½®</button>
                <button id="submitRoundBtn" class="btn btn-success" style="display: none;">æäº¤æœ¬è½®æˆç»©</button>
                <!-- <button id="addGroupBtn" class="btn btn-secondary">æ·»åŠ æ–°ç»„åˆ«</button> -->
                <button id="resetBtn" class="btn btn-danger">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
        </section>

        <!-- å†å²è®°å½•åŒºåŸŸ -->
        <section class="history">
            <h2>ğŸ“ æ¯”èµ›å†å²</h2>
            <div id="historyList" class="history-list">
                <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
            </div>
        </section>

        <!-- æ·»åŠ ç»„åˆ«çš„æ¨¡æ€æ¡† -->
        <div id="addGroupModal" class="modal">
            <div class="modal-content">
                <h3>æ·»åŠ æ–°ç»„åˆ«</h3>
                <p>å°†æ·»åŠ æ–°çš„ç»„åˆ«ï¼š<span id="newGroupName"></span></p>
                <div class="modal-buttons">
                    <button id="confirmAddGroup" class="btn btn-primary">ç¡®è®¤æ·»åŠ </button>
                    <button id="cancelAddGroup" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¡®è®¤é‡ç½®çš„æ¨¡æ€æ¡† -->
        <div id="resetModal" class="modal">
            <div class="modal-content">
                <h3>âš ï¸ ç¡®è®¤é‡ç½®</h3>
                <p>æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ¯”èµ›æ•°æ®ï¼ŒåŒ…æ‹¬æ€»åˆ†å’Œå†å²è®°å½•ã€‚<br>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="confirmReset" class="btn btn-danger">ç¡®è®¤é‡ç½®</button>
                    <button id="cancelReset" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- <footer>
        <p>&copy; 2025 å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ | æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°</p>
    </footer> -->
    </div>

    <!-- ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ -->
    <div id="compare-page" style="display: none;">
        <div class="compare-container">
            <h2>ä½“æµ‹æ•°æ®å¯¹æ¯”ç®¡ç†</h2>
            <div class="compare-controls">
                <label>å›¾è¡¨æ ‡é¢˜ï¼š<input type="text" id="chartTitleInput" value="2301ç­2024ä¸2025ä½“æµ‹æ•°æ®å¯¹æ¯”"
                        style="width:300px;"></label>
                <button id="addProjectBtn" class="btn btn-primary">â• æ·»åŠ é¡¹ç›®</button>
                <button id="addSeriesBtn" class="btn btn-primary">â• æ·»åŠ ç³»åˆ—</button>
                <button id="updateChartBtn" class="btn btn-success">ğŸ”„ åˆ·æ–°å›¾è¡¨</button>
                <button id="exportBtn" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºå›¾ç‰‡</button>
            </div>

            <table id="dataTable">
                <thead id="tableHead">
                    <!-- åŠ¨æ€è¡¨å¤´ -->
                </thead>
                <tbody id="tableBody">
                    <!-- æ•°æ®è¡Œ -->
                </tbody>
            </table>

            <div id="chart"></div>
        </div>
    </div>

    <!-- å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿè„šæœ¬ -->
    <script src="script.js"></script>

    <!-- è·¯ç”±è„šæœ¬ -->
    <script>
        // è·¯ç”±é€»è¾‘
        function initRouter() {
            const urlParams = new URLSearchParams(window.location.search);
            const homePage = document.getElementById('home-page');
            const scoringPage = document.getElementById('scoring-page');
            const comparePage = document.getElementById('compare-page');
            const navScoring = document.getElementById('nav-scoring');
            const navCompare = document.getElementById('nav-compare');

            // éšè—æ‰€æœ‰é¡µé¢
            homePage.style.display = 'none';
            scoringPage.style.display = 'none';
            comparePage.style.display = 'none';

            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæ´»åŠ¨çŠ¶æ€
            navScoring.classList.remove('active');
            navCompare.classList.remove('active');

            if (urlParams.has('scoring')) {
                // æ˜¾ç¤ºå¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ
                scoringPage.style.display = 'block';
                navScoring.classList.add('active');
                document.title = 'å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ - ä½“è‚²å·¥å…·ç³»ç»Ÿ';
                // åˆå§‹åŒ–å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ
                setTimeout(() => {
                    if (typeof initScoringSystem === 'function') {
                        initScoringSystem();
                    }
                }, 0);
            } else if (urlParams.has('compare')) {
                // æ˜¾ç¤ºä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ
                comparePage.style.display = 'block';
                navCompare.classList.add('active');
                document.title = 'ä½“æµ‹æ•°æ®å¯¹æ¯” - ä½“è‚²å·¥å…·ç³»ç»Ÿ';
                // åˆå§‹åŒ–ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ
                setTimeout(() => {
                    initCompareSystem();
                }, 0);
            } else {
                // æ˜¾ç¤ºä¸»é¡µ
                homePage.style.display = 'block';
                document.title = 'ä½“è‚²å·¥å…·ç³»ç»Ÿ';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è·¯ç”±
        window.addEventListener('DOMContentLoaded', initRouter);
    </script>

    <!-- ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿè„šæœ¬ -->
    <script>
        let chartInstance = null;
        let projectData = [];
        let seriesNames = [];
        let draggedElement = null;
        let draggedIndex = null;

        function initCompareSystem() {
            // é»˜è®¤æ•°æ®
            projectData = [
                { name: 'è‚ºæ´»é‡', data: [18, 11, 12, 11, 13, 15] },
                { name: '50ç±³', data: [3, 4, 33, 7, 14, 18] },
                { name: 'åä½ä½“å‰å±ˆ', data: [5, 8, 28, 8, 14, 17] },
                { name: 'ä¸€åˆ†é’Ÿè·³ç»³', data: [31, 8, 1, 37, 1, 1] },
                { name: 'ä¸€åˆ†é’Ÿä»°å§èµ·å', data: [0, 0, 0, 15, 9, 15] },
            ];

            seriesNames = ['2024ä¼˜ç§€', '2024è‰¯å¥½', '2024åŠæ ¼', '2025ä¼˜ç§€', '2025è‰¯å¥½', '2025åŠæ ¼'];

            const chartDom = document.getElementById('chart');
            chartInstance = echarts.init(chartDom);

            renderTableHead();
            renderTable();
            renderChart();

            window.addEventListener('resize', () => chartInstance.resize());

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('addProjectBtn').addEventListener('click', addProject);
            document.getElementById('addSeriesBtn').addEventListener('click', addSeries);
            document.getElementById('updateChartBtn').addEventListener('click', updateChart);
            document.getElementById('exportBtn').addEventListener('click', exportChart);
        }

        const colorPalette = ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC', '#FF9F7F', '#FFDB5C', '#37A2DA'];

        function getColor(index) {
            return colorPalette[index % colorPalette.length];
        }

        function renderTableHead() {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <th style="width: 50px;">æ’åº</th>
                <th>é¡¹ç›®åç§°</th>
                ${seriesNames.map((name, i) => `
                    <th>
                        <input type="text" value="${name}" data-series-index="${i}" class="seriesName">
                        <button data-series-index="${i}" class="deleteSeriesBtn">ğŸ—‘ï¸</button>
                    </th>
                `).join('')}
                <th>åˆ é™¤</th>
            `;
            thead.appendChild(tr);

            document.querySelectorAll('.seriesName').forEach(input => {
                input.addEventListener('blur', e => {
                    const idx = parseInt(e.target.dataset.seriesIndex);
                    seriesNames[idx] = e.target.value;
                    renderChart();
                });
            });

            document.querySelectorAll('.deleteSeriesBtn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const index = parseInt(e.target.dataset.seriesIndex);
                    seriesNames.splice(index, 1);
                    projectData.forEach(proj => {
                        proj.data.splice(index, 1);
                    });
                    renderTableHead();
                    renderTable();
                    renderChart();
                });
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            projectData.forEach((proj, i) => {
                while (proj.data.length < seriesNames.length) {
                    proj.data.push(0);
                }
                while (proj.data.length > seriesNames.length) {
                    proj.data.pop();
                }

                const tr = document.createElement('tr');
                tr.dataset.index = i;
                tr.innerHTML = `
                    <td class="drag-handle" draggable="true">â˜°</td>
                    <td><input type="text" value="${proj.name}" data-index="${i}" class="projName"></td>
                    ${proj.data.map((v, j) => `<td><input type="number" value="${v}" data-row="${i}" data-col="${j}" class="projData"></td>`).join('')}
                    <td><button data-index="${i}" class="deleteBtn">ğŸ—‘ï¸</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const index = e.target.dataset.index;
                    projectData.splice(index, 1);
                    renderTable();
                    renderChart();
                });
            });

            // æ‹–æ‹½æ’åºåŠŸèƒ½
            // åªåœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Šè§¦å‘æ‹–æ‹½
            tbody.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('dragstart', (e) => {
                    const tr = handle.parentElement;
                    draggedElement = tr;
                    draggedIndex = parseInt(tr.dataset.index);
                    tr.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', tr.innerHTML);
                });
            });

            tbody.querySelectorAll('tr').forEach(tr => {
                // æ‹–æ‹½ç»“æŸ
                tr.addEventListener('dragend', (e) => {
                    tr.classList.remove('dragging');
                    // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });

                // æ‹–æ‹½ç»è¿‡
                tr.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    // æ¸…é™¤æ‰€æœ‰è¡Œçš„æ‹–æ‹½æ ·å¼
                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });

                    // ä¸ºå½“å‰è¡Œæ·»åŠ æ‹–æ‹½æ ·å¼
                    if (tr !== draggedElement) {
                        tr.classList.add('drag-over');
                    }
                });

                // æ‹–æ‹½è¿›å…¥
                tr.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (tr !== draggedElement) {
                        tr.classList.add('drag-over');
                    }
                });

                // æ‹–æ‹½ç¦»å¼€
                tr.addEventListener('dragleave', (e) => {
                    tr.classList.remove('drag-over');
                });

                // æ”¾ç½®
                tr.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    if (draggedElement && tr !== draggedElement) {
                        const dropIndex = parseInt(tr.dataset.index);

                        // äº¤æ¢æ•°æ®é¡ºåº
                        const temp = projectData[draggedIndex];
                        projectData[draggedIndex] = projectData[dropIndex];
                        projectData[dropIndex] = temp;

                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨
                        renderTable();
                        renderChart();
                    }

                    // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });
            });
        }

        function renderChart() {
            const categories = projectData.map(p => p.name);
            const series = seriesNames.map((name, i) => ({
                name,
                type: 'bar',
                data: projectData.map(p => {
                    return p.data[i] !== undefined ? p.data[i] : 0;
                }),
                itemStyle: { color: getColor(i) },
                label: { show: true, position: 'top', fontSize: 12 }
            }));

            const option = {
                title: {
                    text: document.getElementById('chartTitleInput').value,
                    left: 'center', top: 10, textStyle: { fontSize: 22, fontWeight: 'bold' }
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { top: 50, data: seriesNames },
                grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        fontSize: 14,
                        interval: 0,
                    }
                },
                yAxis: { type: 'value', name: 'äººæ•°ï¼ˆäººï¼‰', nameTextStyle: { fontSize: 14 } },
                dataZoom: [
                    { type: 'slider', show: true, xAxisIndex: 0, start: 0, end: 100 },
                    { type: 'inside', xAxisIndex: 0 }
                ],
                series
            };

            chartInstance.setOption(option, true);
        }

        function addProject() {
            const newData = new Array(seriesNames.length).fill(0);
            projectData.push({ name: 'æ–°é¡¹ç›®', data: newData });
            renderTable();
        }

        function addSeries() {
            const newSeriesName = prompt('è¯·è¾“å…¥æ–°ç³»åˆ—åç§°ï¼ˆä¾‹å¦‚ï¼š2024ä¸åŠæ ¼ï¼‰:', '2024ä¸åŠæ ¼');
            if (newSeriesName && newSeriesName.trim()) {
                seriesNames.push(newSeriesName.trim());
                projectData.forEach(proj => {
                    proj.data.push(0);
                });
                renderTableHead();
                renderTable();
                renderChart();
            }
        }

        function updateChart() {
            document.querySelectorAll('.projName').forEach(input => {
                const idx = input.dataset.index;
                projectData[idx].name = input.value;
            });
            document.querySelectorAll('.projData').forEach(input => {
                const row = input.dataset.row;
                const col = input.dataset.col;
                projectData[row].data[col] = Number(input.value);
            });
            renderChart();
        }

        function exportChart() {
            const img = chartInstance.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.href = img;
            link.download = document.getElementById('chartTitleInput').value + '.png';
            link.click();
        }
    </script>
</body>

</html>