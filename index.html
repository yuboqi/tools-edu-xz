<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“è‚²å·¥å…·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ğŸƒâ€â™‚ï¸ ä½“è‚²å·¥å…·ç³»ç»Ÿ</a>
            <div class="nav-menu">
                <a href="index.html?scoring" class="nav-item" id="nav-scoring">å¼¯é“è·‘è®¡åˆ†</a>
                <a href="index.html?compare" class="nav-item" id="nav-compare">ä½“æµ‹æ•°æ®å¯¹æ¯”</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»é¡µæ¬¢è¿ç•Œé¢ -->
    <div id="home-page" class="home-container" style="display: none;">
        <header class="home-header">
            <h1>ğŸƒâ€â™‚ï¸ ä½“è‚²å·¥å…·ç³»ç»Ÿ</h1>
            <p class="subtitle">ä¸ºå°å¼ æœåŠ¡çš„ä½“è‚²æ¯”èµ›ä¸æ•°æ®ç®¡ç†å·¥å…·é›†</p>
        </header>
        <div class="tool-cards">
            <div class="tool-card" onclick="window.location.href='index.html?scoring'">
                <div class="tool-icon">ğŸƒâ€â™‚ï¸</div>
                <h3>å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ</h3>
                <p>ç®€å•ã€å‡†ç¡®ã€æ˜“ç”¨çš„æ¯”èµ›è®¡åˆ†å·¥å…·</p>
                <button class="btn btn-primary">å¼€å§‹ä½¿ç”¨</button>
            </div>
            <div class="tool-card" onclick="window.location.href='index.html?compare'">
                <div class="tool-icon">ğŸ“Š</div>
                <h3>ä½“æµ‹æ•°æ®å¯¹æ¯”</h3>
                <p>å¯è§†åŒ–ä½“æµ‹æ•°æ®å¯¹æ¯”åˆ†æå·¥å…·</p>
                <button class="btn btn-primary">å¼€å§‹ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ -->
    <div id="scoring-page" class="container" style="display: none;">
        <header>
            <h1>ğŸƒâ€â™‚ï¸ å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ</h1>
            <p class="subtitle">ç®€å•ã€å‡†ç¡®ã€æ˜“ç”¨çš„æ¯”èµ›è®¡åˆ†å·¥å…·</p>
        </header>

        <!-- æ€»åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
        <section class="scoreboard">
            <h2>ğŸ“Š æ€»åˆ†æ’è¡Œæ¦œ</h2>
            <div id="totalScores" class="score-grid">
                <!-- åŠ¨æ€ç”Ÿæˆæ€»åˆ†æ˜¾ç¤º -->
            </div>
        </section>

        <!-- å½“å‰è½®æ¬¡åŒºåŸŸ -->
        <section class="current-round">
            <h2 id="roundTitle">å‡†å¤‡å¼€å§‹ç¬¬1è½®æ¯”èµ›</h2>
            <div id="currentRoundContent" class="round-content">
                <p class="round-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ–°ä¸€è½®æ¯”èµ›</p>
            </div>
        </section>

        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <section class="controls">
            <div class="button-group">
                <button id="startRoundBtn" class="btn btn-primary">å¼€å§‹æ–°ä¸€è½®</button>
                <button id="submitRoundBtn" class="btn btn-success" style="display: none;">æäº¤æœ¬è½®æˆç»©</button>
                <!-- <button id="addGroupBtn" class="btn btn-secondary">æ·»åŠ æ–°ç»„åˆ«</button> -->
                <button id="resetBtn" class="btn btn-danger">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
        </section>

        <!-- å†å²è®°å½•åŒºåŸŸ -->
        <section class="history">
            <h2>ğŸ“ æ¯”èµ›å†å²</h2>
            <div id="historyList" class="history-list">
                <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
            </div>
        </section>

        <!-- æ·»åŠ ç»„åˆ«çš„æ¨¡æ€æ¡† -->
        <div id="addGroupModal" class="modal">
            <div class="modal-content">
                <h3>æ·»åŠ æ–°ç»„åˆ«</h3>
                <p>å°†æ·»åŠ æ–°çš„ç»„åˆ«ï¼š<span id="newGroupName"></span></p>
                <div class="modal-buttons">
                    <button id="confirmAddGroup" class="btn btn-primary">ç¡®è®¤æ·»åŠ </button>
                    <button id="cancelAddGroup" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¡®è®¤é‡ç½®çš„æ¨¡æ€æ¡† -->
        <div id="resetModal" class="modal">
            <div class="modal-content">
                <h3>âš ï¸ ç¡®è®¤é‡ç½®</h3>
                <p>æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ¯”èµ›æ•°æ®ï¼ŒåŒ…æ‹¬æ€»åˆ†å’Œå†å²è®°å½•ã€‚<br>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="confirmReset" class="btn btn-danger">ç¡®è®¤é‡ç½®</button>
                    <button id="cancelReset" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- <footer>
        <p>&copy; 2025 å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ | æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°</p>
    </footer> -->
    </div>

    <!-- ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ -->
    <div id="compare-page" style="display: none;">
        <div class="compare-container">
            <h2>ä½“æµ‹æ•°æ®å¯¹æ¯”ç®¡ç†</h2>
            
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="compare-toolbar">
                <div class="toolbar-left">
                    <button id="saveDataBtn" class="btn btn-success">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
                    <button id="importDataBtn" class="btn btn-primary">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <button id="exportDataBtn" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <input type="file" id="importFileInput" accept=".json" style="display:none;">
                </div>
                <div class="toolbar-right">
                    <span class="save-status" id="saveStatus">æœªä¿å­˜</span>
                </div>
            </div>

            <!-- å·¥ä½œåŒºæ ‡ç­¾æ  -->
            <div class="workspace-tabs">
                <div class="tabs-container" id="tabsContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆå·¥ä½œåŒºæ ‡ç­¾ -->
                </div>
                <button id="addWorkspaceBtn" class="btn-add-workspace" title="æ–°å»ºå·¥ä½œåŒº">â•</button>
            </div>

            <!-- è‡ªå®šä¹‰Modalï¼šæ–°å»ºå·¥ä½œåŒº -->
            <div id="addWorkspaceModal" class="custom-modal">
                <div class="custom-modal-content">
                    <h3>ğŸ“ æ–°å»ºå·¥ä½œåŒº</h3>
                    <p>è¯·è¾“å…¥æ–°å·¥ä½œåŒºçš„åç§°ï¼š</p>
                    <input type="text" id="newWorkspaceName" class="modal-input" placeholder="ä¾‹å¦‚ï¼š2302ç­æ•°æ®å¯¹æ¯”" maxlength="50">
                    <div class="custom-modal-buttons">
                        <button id="confirmAddWorkspace" class="btn btn-primary">ç¡®è®¤</button>
                        <button id="cancelAddWorkspace" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰Modalï¼šåˆ é™¤å·¥ä½œåŒºç¡®è®¤ -->
            <div id="deleteWorkspaceModal" class="custom-modal">
                <div class="custom-modal-content">
                    <h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
                    <p id="deleteWorkspaceMessage">ç¡®å®šè¦åˆ é™¤å·¥ä½œåŒºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                    <div class="custom-modal-buttons">
                        <button id="confirmDeleteWorkspace" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                        <button id="cancelDeleteWorkspace" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰Modalï¼šé‡å‘½åå·¥ä½œåŒº -->
            <div id="renameWorkspaceModal" class="custom-modal">
                <div class="custom-modal-content">
                    <h3>âœï¸ é‡å‘½åå·¥ä½œåŒº</h3>
                    <p>è¯·è¾“å…¥æ–°åç§°ï¼š</p>
                    <input type="text" id="renameWorkspaceName" class="modal-input" placeholder="è¾“å…¥æ–°åç§°" maxlength="50">
                    <div class="custom-modal-buttons">
                        <button id="confirmRenameWorkspace" class="btn btn-primary">ç¡®è®¤</button>
                        <button id="cancelRenameWorkspace" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç¼–è¾‘æ§åˆ¶æ  -->
            <div class="compare-controls">
                <label>å›¾è¡¨æ ‡é¢˜ï¼š<input type="text" id="chartTitleInput" value="2301ç­2024ä¸2025ä½“æµ‹æ•°æ®å¯¹æ¯”"
                        style="width:300px;"></label>
                <button id="addProjectBtn" class="btn btn-primary">â• æ·»åŠ é¡¹ç›®</button>
                <button id="addSeriesBtn" class="btn btn-primary">â• æ·»åŠ ç³»åˆ—</button>
                <button id="updateChartBtn" class="btn btn-success">ğŸ”„ åˆ·æ–°å›¾è¡¨</button>
                <button id="exportImageBtn" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºå›¾ç‰‡</button>
            </div>

            <table id="dataTable">
                <thead id="tableHead">
                    <!-- åŠ¨æ€è¡¨å¤´ -->
                </thead>
                <tbody id="tableBody">
                    <!-- æ•°æ®è¡Œ -->
                </tbody>
            </table>

            <div id="chart"></div>
        </div>
    </div>

    <!-- å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿè„šæœ¬ -->
    <script src="script.js"></script>

    <!-- è·¯ç”±è„šæœ¬ -->
    <script>
        // è·¯ç”±é€»è¾‘
        function initRouter() {
            const urlParams = new URLSearchParams(window.location.search);
            const homePage = document.getElementById('home-page');
            const scoringPage = document.getElementById('scoring-page');
            const comparePage = document.getElementById('compare-page');
            const navScoring = document.getElementById('nav-scoring');
            const navCompare = document.getElementById('nav-compare');

            // éšè—æ‰€æœ‰é¡µé¢
            homePage.style.display = 'none';
            scoringPage.style.display = 'none';
            comparePage.style.display = 'none';

            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæ´»åŠ¨çŠ¶æ€
            navScoring.classList.remove('active');
            navCompare.classList.remove('active');

            if (urlParams.has('scoring')) {
                // æ˜¾ç¤ºå¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ
                scoringPage.style.display = 'block';
                navScoring.classList.add('active');
                document.title = 'å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ - ä½“è‚²å·¥å…·ç³»ç»Ÿ';
                // åˆå§‹åŒ–å¼¯é“è·‘è®¡åˆ†ç³»ç»Ÿ
                setTimeout(() => {
                    if (typeof initScoringSystem === 'function') {
                        initScoringSystem();
                    }
                }, 0);
            } else if (urlParams.has('compare')) {
                // æ˜¾ç¤ºä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ
                comparePage.style.display = 'block';
                navCompare.classList.add('active');
                document.title = 'ä½“æµ‹æ•°æ®å¯¹æ¯” - ä½“è‚²å·¥å…·ç³»ç»Ÿ';
                // åˆå§‹åŒ–ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿ
                setTimeout(() => {
                    initCompareSystem();
                }, 0);
            } else {
                // æ˜¾ç¤ºä¸»é¡µ
                homePage.style.display = 'block';
                document.title = 'ä½“è‚²å·¥å…·ç³»ç»Ÿ';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è·¯ç”±
        window.addEventListener('DOMContentLoaded', initRouter);
    </script>

    <!-- ä½“æµ‹æ•°æ®å¯¹æ¯”ç³»ç»Ÿè„šæœ¬ -->
    <script>
        // å¤šå·¥ä½œåŒºç®¡ç†ç³»ç»Ÿ
        class CompareSystem {
            constructor() {
                this.workspaces = []; // æ‰€æœ‰å·¥ä½œåŒº
                this.currentWorkspaceId = null; // å½“å‰æ´»è·ƒå·¥ä½œåŒºID
                this.chartInstance = null;
                this.draggedElement = null;
                this.draggedIndex = null;
                this.hasUnsavedChanges = false;

                // åˆå§‹åŒ–
                this.init();
            }

            init() {
                // åŠ è½½æ•°æ®æˆ–åˆ›å»ºé»˜è®¤å·¥ä½œåŒº
                this.loadData();
                
                // åˆå§‹åŒ–å›¾è¡¨
                const chartDom = document.getElementById('chart');
                this.chartInstance = echarts.init(chartDom);
                window.addEventListener('resize', () => this.chartInstance.resize());

                // ç»‘å®šäº‹ä»¶
                this.bindEvents();

                // æ¸²æŸ“ç•Œé¢
                this.renderWorkspaceTabs();
                this.loadWorkspace(this.currentWorkspaceId);
            }

            bindEvents() {
                // å·¥ä½œåŒºç®¡ç†
                document.getElementById('addWorkspaceBtn').addEventListener('click', () => this.showAddWorkspaceModal());

                // æ•°æ®æ“ä½œ
                document.getElementById('addProjectBtn').addEventListener('click', () => this.addProject());
                document.getElementById('addSeriesBtn').addEventListener('click', () => this.addSeries());
                document.getElementById('updateChartBtn').addEventListener('click', () => this.updateChart());
                document.getElementById('exportImageBtn').addEventListener('click', () => this.exportImage());

                // ä¿å­˜å’Œå¯¼å…¥å¯¼å‡º
                document.getElementById('saveDataBtn').addEventListener('click', () => this.saveData());
                document.getElementById('importDataBtn').addEventListener('click', () => this.importData());
                document.getElementById('exportDataBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importFileInput').addEventListener('change', (e) => this.handleImportFile(e));

                // ç›‘å¬å›¾è¡¨æ ‡é¢˜å˜åŒ–
                document.getElementById('chartTitleInput').addEventListener('input', () => {
                    this.markUnsaved();
                });

                // è‡ªå®šä¹‰Modaläº‹ä»¶ç»‘å®š
                this.bindModalEvents();
            }

            // ç»‘å®šModaläº‹ä»¶
            bindModalEvents() {
                // æ–°å»ºå·¥ä½œåŒºModal
                document.getElementById('confirmAddWorkspace').addEventListener('click', () => this.confirmAddWorkspace());
                document.getElementById('cancelAddWorkspace').addEventListener('click', () => this.hideAddWorkspaceModal());
                
                // åˆ é™¤å·¥ä½œåŒºModal
                document.getElementById('confirmDeleteWorkspace').addEventListener('click', () => this.confirmDeleteWorkspace());
                document.getElementById('cancelDeleteWorkspace').addEventListener('click', () => this.hideDeleteWorkspaceModal());
                
                // é‡å‘½åå·¥ä½œåŒºModal
                document.getElementById('confirmRenameWorkspace').addEventListener('click', () => this.confirmRenameWorkspace());
                document.getElementById('cancelRenameWorkspace').addEventListener('click', () => this.hideRenameWorkspaceModal());

                // ç‚¹å‡»ModalèƒŒæ™¯å…³é—­
                document.getElementById('addWorkspaceModal').addEventListener('click', (e) => {
                    if (e.target.id === 'addWorkspaceModal') this.hideAddWorkspaceModal();
                });
                document.getElementById('deleteWorkspaceModal').addEventListener('click', (e) => {
                    if (e.target.id === 'deleteWorkspaceModal') this.hideDeleteWorkspaceModal();
                });
                document.getElementById('renameWorkspaceModal').addEventListener('click', (e) => {
                    if (e.target.id === 'renameWorkspaceModal') this.hideRenameWorkspaceModal();
                });

                // Enteré”®ç¡®è®¤
                document.getElementById('newWorkspaceName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.confirmAddWorkspace();
                });
                document.getElementById('renameWorkspaceName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.confirmRenameWorkspace();
                });
            }

            // åˆ›å»ºé»˜è®¤å·¥ä½œåŒº
            createDefaultWorkspace() {
                const workspace = {
                    id: this.generateId(),
                    name: '2301ç­2024ä¸2025ä½“æµ‹æ•°æ®å¯¹æ¯”',
                    title: '2301ç­2024ä¸2025ä½“æµ‹æ•°æ®å¯¹æ¯”',
                    projectData: [
                { name: 'è‚ºæ´»é‡', data: [18, 11, 12, 11, 13, 15] },
                { name: '50ç±³', data: [3, 4, 33, 7, 14, 18] },
                { name: 'åä½ä½“å‰å±ˆ', data: [5, 8, 28, 8, 14, 17] },
                { name: 'ä¸€åˆ†é’Ÿè·³ç»³', data: [31, 8, 1, 37, 1, 1] },
                { name: 'ä¸€åˆ†é’Ÿä»°å§èµ·å', data: [0, 0, 0, 15, 9, 15] },
                    ],
                    seriesNames: ['2024ä¼˜ç§€', '2024è‰¯å¥½', '2024åŠæ ¼', '2025ä¼˜ç§€', '2025è‰¯å¥½', '2025åŠæ ¼']
                };
                return workspace;
            }

            generateId() {
                return 'ws_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // åŠ è½½æ•°æ®
            loadData() {
                try {
                    const savedData = localStorage.getItem('compareSystemData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        this.workspaces = data.workspaces || [];
                        this.currentWorkspaceId = data.currentWorkspaceId || null;
                        
                        // å¦‚æœæ²¡æœ‰å·¥ä½œåŒºï¼Œåˆ›å»ºé»˜è®¤çš„
                        if (this.workspaces.length === 0) {
                            const defaultWorkspace = this.createDefaultWorkspace();
                            this.workspaces.push(defaultWorkspace);
                            this.currentWorkspaceId = defaultWorkspace.id;
                        }
                        
                        console.log('æ•°æ®åŠ è½½æˆåŠŸ', data);
                        this.updateSaveStatus('å·²ä¿å­˜');
                    } else {
                        // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºé»˜è®¤å·¥ä½œåŒº
                        const defaultWorkspace = this.createDefaultWorkspace();
                        this.workspaces.push(defaultWorkspace);
                        this.currentWorkspaceId = defaultWorkspace.id;
                    }
                } catch (error) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    const defaultWorkspace = this.createDefaultWorkspace();
                    this.workspaces.push(defaultWorkspace);
                    this.currentWorkspaceId = defaultWorkspace.id;
                }
                this.hasUnsavedChanges = false;
            }

            // ä¿å­˜æ•°æ®
            saveData() {
                try {
                    // ä¿å­˜å½“å‰å·¥ä½œåŒºçš„æ•°æ®
                    this.saveCurrentWorkspace();
                    
                    const data = {
                        workspaces: this.workspaces,
                        currentWorkspaceId: this.currentWorkspaceId,
                        savedTime: new Date().toLocaleString()
                    };
                    localStorage.setItem('compareSystemData', JSON.stringify(data));
                    console.log('æ•°æ®ä¿å­˜æˆåŠŸ', data);
                    this.hasUnsavedChanges = false;
                    this.updateSaveStatus('å·²ä¿å­˜');
                    this.showMessage('æ•°æ®ä¿å­˜æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('æ•°æ®ä¿å­˜å¤±è´¥:', error);
                    this.showMessage('æ•°æ®ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            // ä¿å­˜å½“å‰å·¥ä½œåŒºæ•°æ®
            saveCurrentWorkspace() {
                const workspace = this.getCurrentWorkspace();
                if (!workspace) return;

                // ä»è¡¨å•è¯»å–å½“å‰æ•°æ®
                workspace.title = document.getElementById('chartTitleInput').value;
                workspace.name = workspace.title; // å·¥ä½œåŒºåç§°åŒæ­¥ä¸ºæ ‡é¢˜

                // è¯»å–é¡¹ç›®æ•°æ®
                document.querySelectorAll('.projName').forEach(input => {
                    const idx = input.dataset.index;
                    if (workspace.projectData[idx]) {
                        workspace.projectData[idx].name = input.value;
                    }
                });

                document.querySelectorAll('.projData').forEach(input => {
                    const row = input.dataset.row;
                    const col = input.dataset.col;
                    if (workspace.projectData[row] && workspace.projectData[row].data[col] !== undefined) {
                        workspace.projectData[row].data[col] = Number(input.value);
                    }
                });
            }

            getCurrentWorkspace() {
                return this.workspaces.find(ws => ws.id === this.currentWorkspaceId);
            }

            // åŠ è½½å·¥ä½œåŒº
            loadWorkspace(workspaceId) {
                const workspace = this.workspaces.find(ws => ws.id === workspaceId);
                if (!workspace) return;

                this.currentWorkspaceId = workspaceId;
                
                // æ›´æ–°æ ‡é¢˜
                document.getElementById('chartTitleInput').value = workspace.title || workspace.name;

                // æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨
                this.renderTableHead(workspace);
                this.renderTable(workspace);
                this.renderChart(workspace);

                // æ›´æ–°æ ‡ç­¾é«˜äº®
                this.renderWorkspaceTabs();
            }

            // æ¸²æŸ“å·¥ä½œåŒºæ ‡ç­¾
            renderWorkspaceTabs() {
                const container = document.getElementById('tabsContainer');
                container.innerHTML = '';

                this.workspaces.forEach(workspace => {
                    const tab = document.createElement('div');
                    tab.className = 'workspace-tab' + (workspace.id === this.currentWorkspaceId ? ' active' : '');
                    // æ·»åŠ titleå±æ€§ï¼Œhoveræ—¶æ˜¾ç¤ºå®Œæ•´æ ‡é¢˜
                    tab.title = workspace.name || 'æœªå‘½åå·¥ä½œåŒº';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'tab-name';
                    nameSpan.textContent = workspace.name || 'æœªå‘½åå·¥ä½œåŒº';
                    nameSpan.addEventListener('dblclick', () => this.showRenameWorkspaceModal(workspace.id));
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'tab-close';
                    closeBtn.innerHTML = 'Ã—';
                    closeBtn.title = 'å…³é—­å·¥ä½œåŒº';
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showDeleteWorkspaceModal(workspace.id);
                    });

                    tab.appendChild(nameSpan);
                    if (this.workspaces.length > 1) {
                        tab.appendChild(closeBtn);
                    }
                    
                    tab.addEventListener('click', () => {
                        if (this.currentWorkspaceId !== workspace.id) {
                            this.saveCurrentWorkspace();
                            this.loadWorkspace(workspace.id);
                        }
                    });

                    container.appendChild(tab);
                });
            }

            // Modalï¼šæ˜¾ç¤ºæ–°å»ºå·¥ä½œåŒº
            showAddWorkspaceModal() {
                const modal = document.getElementById('addWorkspaceModal');
                const input = document.getElementById('newWorkspaceName');
                input.value = '';
                modal.style.display = 'flex';
                setTimeout(() => input.focus(), 100);
            }

            hideAddWorkspaceModal() {
                document.getElementById('addWorkspaceModal').style.display = 'none';
            }

            confirmAddWorkspace() {
                const input = document.getElementById('newWorkspaceName');
                const name = input.value.trim();
                
                if (!name) {
                    this.showMessage('è¯·è¾“å…¥å·¥ä½œåŒºåç§°ï¼', 'warning');
                    input.focus();
                    return;
                }

                // ä½¿ç”¨å®Œæ•´çš„é»˜è®¤æ•°æ®ç»“æ„
                const newWorkspace = {
                    id: this.generateId(),
                    name: name,
                    title: name,
                    projectData: [
                        { name: 'è‚ºæ´»é‡', data: [0, 0, 0, 0, 0, 0] },
                        { name: '50ç±³', data: [0, 0, 0, 0, 0, 0] },
                        { name: 'åä½ä½“å‰å±ˆ', data: [0, 0, 0, 0, 0, 0] },
                        { name: 'ä¸€åˆ†é’Ÿè·³ç»³', data: [0, 0, 0, 0, 0, 0] },
                        { name: 'ä¸€åˆ†é’Ÿä»°å§èµ·å', data: [0, 0, 0, 0, 0, 0] },
                    ],
                    seriesNames: ['2024ä¼˜ç§€', '2024è‰¯å¥½', '2024åŠæ ¼', '2025ä¼˜ç§€', '2025è‰¯å¥½', '2025åŠæ ¼']
                };

                this.workspaces.push(newWorkspace);
                this.saveCurrentWorkspace();
                this.loadWorkspace(newWorkspace.id);
                this.hideAddWorkspaceModal();
                // è‡ªåŠ¨ä¿å­˜
                this.saveData();
                this.showMessage('å·¥ä½œåŒºåˆ›å»ºæˆåŠŸï¼', 'success');
            }

            // Modalï¼šæ˜¾ç¤ºé‡å‘½åå·¥ä½œåŒº
            showRenameWorkspaceModal(workspaceId) {
                const workspace = this.workspaces.find(ws => ws.id === workspaceId);
                if (!workspace) return;

                this.renamingWorkspaceId = workspaceId;
                const modal = document.getElementById('renameWorkspaceModal');
                const input = document.getElementById('renameWorkspaceName');
                input.value = workspace.name;
                modal.style.display = 'flex';
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
            }

            hideRenameWorkspaceModal() {
                document.getElementById('renameWorkspaceModal').style.display = 'none';
                this.renamingWorkspaceId = null;
            }

            confirmRenameWorkspace() {
                const input = document.getElementById('renameWorkspaceName');
                const newName = input.value.trim();
                
                if (!newName) {
                    this.showMessage('è¯·è¾“å…¥å·¥ä½œåŒºåç§°ï¼', 'warning');
                    input.focus();
                    return;
                }

                const workspace = this.workspaces.find(ws => ws.id === this.renamingWorkspaceId);
                if (!workspace) return;

                workspace.name = newName;
                workspace.title = newName;
                
                if (workspace.id === this.currentWorkspaceId) {
                    document.getElementById('chartTitleInput').value = workspace.title;
                    this.renderChart(workspace);
                }
                
                this.renderWorkspaceTabs();
                this.hideRenameWorkspaceModal();
                this.markUnsaved();
                this.showMessage('å·¥ä½œåŒºé‡å‘½åæˆåŠŸï¼', 'success');
            }

            // Modalï¼šæ˜¾ç¤ºåˆ é™¤å·¥ä½œåŒºç¡®è®¤
            showDeleteWorkspaceModal(workspaceId) {
                if (this.workspaces.length <= 1) {
                    this.showMessage('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå·¥ä½œåŒºï¼', 'warning');
                    return;
                }

                const workspace = this.workspaces.find(ws => ws.id === workspaceId);
                if (!workspace) return;

                this.deletingWorkspaceId = workspaceId;
                const modal = document.getElementById('deleteWorkspaceModal');
                const message = document.getElementById('deleteWorkspaceMessage');
                message.innerHTML = `ç¡®å®šè¦åˆ é™¤å·¥ä½œåŒº<br><strong>"${workspace.name}"</strong>å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
                modal.style.display = 'flex';
            }

            hideDeleteWorkspaceModal() {
                document.getElementById('deleteWorkspaceModal').style.display = 'none';
                this.deletingWorkspaceId = null;
            }

            confirmDeleteWorkspace() {
                const workspaceId = this.deletingWorkspaceId;
                if (!workspaceId) return;

                const index = this.workspaces.findIndex(ws => ws.id === workspaceId);
                if (index === -1) return;

                this.workspaces.splice(index, 1);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å·¥ä½œåŒºï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
                if (this.currentWorkspaceId === workspaceId) {
                    this.loadWorkspace(this.workspaces[0].id);
                }

                this.renderWorkspaceTabs();
                this.hideDeleteWorkspaceModal();
                // è‡ªåŠ¨ä¿å­˜
                this.saveData();
                this.showMessage('å·¥ä½œåŒºå·²åˆ é™¤', 'success');
            }

            // å¯¼å…¥æ•°æ®
            importData() {
                document.getElementById('importFileInput').click();
            }

            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!data.workspaces || !Array.isArray(data.workspaces)) {
                            throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                        }

                        if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰å·¥ä½œåŒºï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                            this.workspaces = data.workspaces;
                            this.currentWorkspaceId = data.currentWorkspaceId || this.workspaces[0].id;
                            this.loadWorkspace(this.currentWorkspaceId);
                            this.renderWorkspaceTabs();
                            // è‡ªåŠ¨ä¿å­˜
                            this.saveData();
                            this.showMessage('æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        this.showMessage('æ•°æ®å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
                
                // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                event.target.value = '';
            }

            // å¯¼å‡ºæ•°æ®
            exportData() {
                try {
                    this.saveCurrentWorkspace();
                    
                    const data = {
                        workspaces: this.workspaces,
                        currentWorkspaceId: this.currentWorkspaceId,
                        exportTime: new Date().toLocaleString(),
                        version: '1.0'
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ä½“æµ‹æ•°æ®_${new Date().toISOString().slice(0, 10)}.json`;
                    link.click();
                    URL.revokeObjectURL(url);

                    this.showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    this.showMessage('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            // æ ‡è®°æœªä¿å­˜
            markUnsaved() {
                this.hasUnsavedChanges = true;
                this.updateSaveStatus('æœªä¿å­˜ *');
            }

            // æ›´æ–°ä¿å­˜çŠ¶æ€
            updateSaveStatus(status) {
                const statusEl = document.getElementById('saveStatus');
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = 'save-status ' + (status.includes('æœªä¿å­˜') ? 'unsaved' : 'saved');
                }
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                
                const colors = {
                    success: '#38a169',
                    error: '#e53e3e',
                    warning: '#d69e2e',
                    info: '#3182ce'
                };

                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${colors[type] || colors.info};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 2000;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }

            getColorPalette() {
                return ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC', '#FF9F7F', '#FFDB5C', '#37A2DA'];
            }

            getColor(index) {
                const palette = this.getColorPalette();
                return palette[index % palette.length];
            }

            // æ¸²æŸ“è¡¨å¤´
            renderTableHead(workspace) {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <th style="width: 50px;">æ’åº</th>
                <th>é¡¹ç›®åç§°</th>
                    ${workspace.seriesNames.map((name, i) => `
                    <th>
                        <input type="text" value="${name}" data-series-index="${i}" class="seriesName">
                        <button data-series-index="${i}" class="deleteSeriesBtn">ğŸ—‘ï¸</button>
                    </th>
                `).join('')}
                <th>åˆ é™¤</th>
            `;
            thead.appendChild(tr);

            document.querySelectorAll('.seriesName').forEach(input => {
                input.addEventListener('blur', e => {
                    const idx = parseInt(e.target.dataset.seriesIndex);
                        workspace.seriesNames[idx] = e.target.value;
                        this.renderChart(workspace);
                        this.markUnsaved();
                    });
            });

            document.querySelectorAll('.deleteSeriesBtn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const index = parseInt(e.target.dataset.seriesIndex);
                        workspace.seriesNames.splice(index, 1);
                        workspace.projectData.forEach(proj => {
                        proj.data.splice(index, 1);
                        });
                        this.renderTableHead(workspace);
                        this.renderTable(workspace);
                        this.renderChart(workspace);
                        this.markUnsaved();
                });
            });
        }

            // æ¸²æŸ“è¡¨æ ¼
            renderTable(workspace) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
                workspace.projectData.forEach((proj, i) => {
                    while (proj.data.length < workspace.seriesNames.length) {
                    proj.data.push(0);
                }
                    while (proj.data.length > workspace.seriesNames.length) {
                    proj.data.pop();
                }

                const tr = document.createElement('tr');
                tr.dataset.index = i;
                tr.innerHTML = `
                    <td class="drag-handle" draggable="true">â˜°</td>
                    <td><input type="text" value="${proj.name}" data-index="${i}" class="projName"></td>
                    ${proj.data.map((v, j) => `<td><input type="number" value="${v}" data-row="${i}" data-col="${j}" class="projData"></td>`).join('')}
                    <td><button data-index="${i}" class="deleteBtn">ğŸ—‘ï¸</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const index = e.target.dataset.index;
                        workspace.projectData.splice(index, 1);
                        this.renderTable(workspace);
                        this.renderChart(workspace);
                        this.markUnsaved();
                    });
            });

            // æ‹–æ‹½æ’åºåŠŸèƒ½
            tbody.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('dragstart', (e) => {
                    const tr = handle.parentElement;
                        this.draggedElement = tr;
                        this.draggedIndex = parseInt(tr.dataset.index);
                    tr.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', tr.innerHTML);
                });
            });

            tbody.querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('dragend', (e) => {
                    tr.classList.remove('dragging');
                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });

                tr.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                        if (tr !== this.draggedElement) {
                        tr.classList.add('drag-over');
                    }
                });

                tr.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                        if (tr !== this.draggedElement) {
                        tr.classList.add('drag-over');
                    }
                });

                tr.addEventListener('dragleave', (e) => {
                    tr.classList.remove('drag-over');
                });

                tr.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                        if (this.draggedElement && tr !== this.draggedElement) {
                        const dropIndex = parseInt(tr.dataset.index);
                            const temp = workspace.projectData[this.draggedIndex];
                            workspace.projectData[this.draggedIndex] = workspace.projectData[dropIndex];
                            workspace.projectData[dropIndex] = temp;
                            this.renderTable(workspace);
                            this.renderChart(workspace);
                            this.markUnsaved();
                        }

                    tbody.querySelectorAll('tr').forEach(row => {
                        row.classList.remove('drag-over');
                    });
                });
            });
        }

            // æ¸²æŸ“å›¾è¡¨
            renderChart(workspace) {
                const categories = workspace.projectData.map(p => p.name);
                const series = workspace.seriesNames.map((name, i) => ({
                name,
                type: 'bar',
                    data: workspace.projectData.map(p => {
                    return p.data[i] !== undefined ? p.data[i] : 0;
                }),
                    itemStyle: { color: this.getColor(i) },
                label: { show: true, position: 'top', fontSize: 12 }
            }));

            const option = {
                title: {
                        text: workspace.title || workspace.name,
                    left: 'center', top: 10, textStyle: { fontSize: 22, fontWeight: 'bold' }
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: { top: 50, data: workspace.seriesNames },
                grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        fontSize: 14,
                        interval: 0,
                    }
                },
                yAxis: { type: 'value', name: 'äººæ•°ï¼ˆäººï¼‰', nameTextStyle: { fontSize: 14 } },
                dataZoom: [
                    { type: 'slider', show: true, xAxisIndex: 0, start: 0, end: 100 },
                    { type: 'inside', xAxisIndex: 0 }
                ],
                series
            };

                this.chartInstance.setOption(option, true);
            }

            // æ·»åŠ é¡¹ç›®
            addProject() {
                const workspace = this.getCurrentWorkspace();
                if (!workspace) return;

                const newData = new Array(workspace.seriesNames.length).fill(0);
                workspace.projectData.push({ name: 'æ–°é¡¹ç›®', data: newData });
                this.renderTable(workspace);
                this.markUnsaved();
            }

            // æ·»åŠ ç³»åˆ—
            addSeries() {
                const workspace = this.getCurrentWorkspace();
                if (!workspace) return;

            const newSeriesName = prompt('è¯·è¾“å…¥æ–°ç³»åˆ—åç§°ï¼ˆä¾‹å¦‚ï¼š2024ä¸åŠæ ¼ï¼‰:', '2024ä¸åŠæ ¼');
            if (newSeriesName && newSeriesName.trim()) {
                    workspace.seriesNames.push(newSeriesName.trim());
                    workspace.projectData.forEach(proj => {
                    proj.data.push(0);
                });
                    this.renderTableHead(workspace);
                    this.renderTable(workspace);
                    this.renderChart(workspace);
                    this.markUnsaved();
                }
            }

            // æ›´æ–°å›¾è¡¨
            updateChart() {
                const workspace = this.getCurrentWorkspace();
                if (!workspace) return;

            document.querySelectorAll('.projName').forEach(input => {
                const idx = input.dataset.index;
                    if (workspace.projectData[idx]) {
                        workspace.projectData[idx].name = input.value;
                    }
            });
            document.querySelectorAll('.projData').forEach(input => {
                const row = input.dataset.row;
                const col = input.dataset.col;
                    if (workspace.projectData[row] && workspace.projectData[row].data[col] !== undefined) {
                        workspace.projectData[row].data[col] = Number(input.value);
                    }
                });
                
                workspace.title = document.getElementById('chartTitleInput').value;
                workspace.name = workspace.title;
                
                this.renderChart(workspace);
                this.renderWorkspaceTabs();
                this.markUnsaved();
            }

            // å¯¼å‡ºå›¾ç‰‡
            exportImage() {
                const workspace = this.getCurrentWorkspace();
                if (!workspace) return;

                const img = this.chartInstance.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.href = img;
                link.download = (workspace.title || workspace.name) + '.png';
            link.click();
                this.showMessage('å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼', 'success');
            }
        }

        // å…¨å±€å®ä¾‹
        let compareSystemInstance = null;

        // åˆå§‹åŒ–å‡½æ•°
        function initCompareSystem() {
            if (!compareSystemInstance) {
                compareSystemInstance = new CompareSystem();
            }
        }
    </script>
</body>

</html>