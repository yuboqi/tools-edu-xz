<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>ä½“æµ‹æ•°æ®å¯¹æ¯”</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft YaHei", sans-serif;
      background: #f8fafc;
      padding: 20px;
    }

    #chart {
      width: 90%;
      height: 600px;
      margin-top: 20px;
    }

    input[type="text"],
    input[type="number"] {
      padding: 4px 6px;
      font-size: 13px;
      width: 80px;
    }

    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
      max-width: 1200px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: center;
    }

    th {
      background: #e2e8f0;
      position: relative;
    }

    .seriesName {
      width: 100px;
      text-align: center;
      border: 1px solid transparent;
      background: transparent;
      font-weight: bold;
      padding: 2px 4px;
    }

    .seriesName:hover {
      border: 1px solid #94a3b8;
      background: #f1f5f9;
    }

    .seriesName:focus {
      border: 1px solid #2563eb;
      background: white;
      outline: none;
    }

    .deleteSeriesBtn {
      margin-left: 5px;
      padding: 2px 6px;
      font-size: 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .deleteSeriesBtn:hover {
      background: #dc2626;
    }

    button {
      margin-top: 10px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #1e40af;
    }

    /* æ‹–æ‹½æ’åºç›¸å…³æ ·å¼ */
    tbody tr {
      transition: background-color 0.2s;
    }

    tbody tr:hover {
      background-color: #f1f5f9;
    }

    tbody tr.dragging {
      opacity: 0.5;
      background-color: #e2e8f0;
    }

    tbody tr.drag-over {
      border-top: 3px solid #2563eb;
    }

    /* æ‹–æ‹½æ‰‹æŸ„æ ·å¼ */
    .drag-handle {
      cursor: grab;
      font-size: 18px;
      color: #94a3b8;
      user-select: none;
      padding: 8px;
    }

    .drag-handle:hover {
      color: #2563eb;
    }

    .drag-handle:active {
      cursor: grabbing;
    }
  </style>
</head>

<body>

  <h2>ä½“æµ‹æ•°æ®å¯¹æ¯”ç®¡ç†</h2>
  <label>å›¾è¡¨æ ‡é¢˜ï¼š<input type="text" id="chartTitleInput" value="2301ç­2024ä¸2025ä½“æµ‹æ•°æ®å¯¹æ¯”" style="width:300px;"></label>
  <button id="addProjectBtn">â• æ·»åŠ é¡¹ç›®</button>
  <button id="addSeriesBtn">â• æ·»åŠ ç³»åˆ—</button>
  <button id="updateChartBtn">ğŸ”„ åˆ·æ–°å›¾è¡¨</button>
  <button id="exportBtn">ğŸ“¤ å¯¼å‡ºå›¾ç‰‡</button>

  <table id="dataTable">
    <thead id="tableHead">
      <!-- åŠ¨æ€è¡¨å¤´ -->
    </thead>
    <tbody id="tableBody">
      <!-- æ•°æ®è¡Œ -->
    </tbody>
  </table>

  <div id="chart"></div>

  <script>
    const chartDom = document.getElementById('chart');
    const myChart = echarts.init(chartDom);

    // é»˜è®¤æ•°æ®
    let projectData = [
      { name: 'è‚ºæ´»é‡', data: [18, 11, 12, 11, 13, 15] },
      { name: '50ç±³', data: [3, 4, 33, 7, 14, 18] },
      { name: 'åä½ä½“å‰å±ˆ', data: [5, 8, 28, 8, 14, 17] },
      { name: 'ä¸€åˆ†é’Ÿè·³ç»³', data: [31, 8, 1, 37, 1, 1] },
      { name: 'ä¸€åˆ†é’Ÿä»°å§èµ·å', data: [0, 0, 0, 15, 9, 15] },
    ];

    // å¯åŠ¨æ€æ·»åŠ çš„ç³»åˆ—åç§°æ•°ç»„
    let seriesNames = ['2024ä¼˜ç§€', '2024è‰¯å¥½', '2024åŠæ ¼', '2025ä¼˜ç§€', '2025è‰¯å¥½', '2025åŠæ ¼'];
    // æ‰©å±•çš„é¢œè‰²æ•°ç»„ï¼Œæ”¯æŒæ›´å¤šç³»åˆ—
    const colorPalette = ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC', '#FF9F7F', '#FFDB5C', '#37A2DA'];
    
    // æ‹–æ‹½æ’åºç›¸å…³å˜é‡
    let draggedElement = null;
    let draggedIndex = null;

    // è·å–é¢œè‰²å‡½æ•°ï¼Œå¦‚æœç³»åˆ—æ•°é‡è¶…è¿‡é¢„è®¾é¢œè‰²ï¼Œåˆ™å¾ªç¯ä½¿ç”¨
    function getColor(index) {
      return colorPalette[index % colorPalette.length];
    }

    // æ¸²æŸ“è¡¨å¤´
    function renderTableHead() {
      const thead = document.getElementById('tableHead');
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <th style="width: 50px;">æ’åº</th>
        <th>é¡¹ç›®åç§°</th>
        ${seriesNames.map((name, i) => `
          <th>
            <input type="text" value="${name}" data-series-index="${i}" class="seriesName">
            <button data-series-index="${i}" class="deleteSeriesBtn">ğŸ—‘ï¸</button>
          </th>
        `).join('')}
        <th>åˆ é™¤</th>
      `;
      thead.appendChild(tr);

      // ç»‘å®šç³»åˆ—åç§°ç¼–è¾‘äº‹ä»¶
      document.querySelectorAll('.seriesName').forEach(input => {
        input.addEventListener('blur', e => {
          const idx = parseInt(e.target.dataset.seriesIndex);
          seriesNames[idx] = e.target.value;
          renderChart();
        });
      });

      // ç»‘å®šåˆ é™¤ç³»åˆ—äº‹ä»¶
      document.querySelectorAll('.deleteSeriesBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          const index = parseInt(e.target.dataset.seriesIndex);
          // åˆ é™¤ç³»åˆ—åç§°
          seriesNames.splice(index, 1);
          // åˆ é™¤æ‰€æœ‰é¡¹ç›®å¯¹åº”çš„æ•°æ®åˆ—
          projectData.forEach(proj => {
            proj.data.splice(index, 1);
          });
          renderTableHead();
          renderTable();
          renderChart();
        });
      });
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      projectData.forEach((proj, i) => {
        // ç¡®ä¿æ•°æ®æ•°ç»„é•¿åº¦ä¸ç³»åˆ—æ•°é‡ä¸€è‡´
        while (proj.data.length < seriesNames.length) {
          proj.data.push(0);
        }
        while (proj.data.length > seriesNames.length) {
          proj.data.pop();
        }

        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
      <td class="drag-handle" draggable="true">â˜°</td>
      <td><input type="text" value="${proj.name}" data-index="${i}" class="projName"></td>
      ${proj.data.map((v, j) => `<td><input type="number" value="${v}" data-row="${i}" data-col="${j}" class="projData"></td>`).join('')}
      <td><button data-index="${i}" class="deleteBtn">ğŸ—‘ï¸</button></td>
    `;
        tbody.appendChild(tr);
      });

      // åˆ é™¤è¡Œ
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', e => {
          const index = e.target.dataset.index;
          projectData.splice(index, 1);
          renderTable();
          renderChart();
        });
      });

      // æ‹–æ‹½æ’åºåŠŸèƒ½
      // åªåœ¨æ‹–æ‹½æ‰‹æŸ„ä¸Šè§¦å‘æ‹–æ‹½
      tbody.querySelectorAll('.drag-handle').forEach(handle => {
        handle.addEventListener('dragstart', (e) => {
          const tr = handle.parentElement;
          draggedElement = tr;
          draggedIndex = parseInt(tr.dataset.index);
          tr.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', tr.innerHTML);
        });
      });

      tbody.querySelectorAll('tr').forEach(tr => {

        // æ‹–æ‹½ç»“æŸ
        tr.addEventListener('dragend', (e) => {
          tr.classList.remove('dragging');
          // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
          tbody.querySelectorAll('tr').forEach(row => {
            row.classList.remove('drag-over');
          });
        });

        // æ‹–æ‹½ç»è¿‡
        tr.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          
          // æ¸…é™¤æ‰€æœ‰è¡Œçš„æ‹–æ‹½æ ·å¼
          tbody.querySelectorAll('tr').forEach(row => {
            row.classList.remove('drag-over');
          });
          
          // ä¸ºå½“å‰è¡Œæ·»åŠ æ‹–æ‹½æ ·å¼
          if (tr !== draggedElement) {
            tr.classList.add('drag-over');
          }
        });

        // æ‹–æ‹½è¿›å…¥
        tr.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (tr !== draggedElement) {
            tr.classList.add('drag-over');
          }
        });

        // æ‹–æ‹½ç¦»å¼€
        tr.addEventListener('dragleave', (e) => {
          tr.classList.remove('drag-over');
        });

        // æ”¾ç½®
        tr.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (draggedElement && tr !== draggedElement) {
            const dropIndex = parseInt(tr.dataset.index);
            
            // äº¤æ¢æ•°æ®é¡ºåº
            const temp = projectData[draggedIndex];
            projectData[draggedIndex] = projectData[dropIndex];
            projectData[dropIndex] = temp;
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨
            renderTable();
            renderChart();
          }
          
          // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
          tbody.querySelectorAll('tr').forEach(row => {
            row.classList.remove('drag-over');
          });
        });
      });
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderChart() {
      const categories = projectData.map(p => p.name);
      const series = seriesNames.map((name, i) => ({
        name,
        type: 'bar',
        data: projectData.map(p => {
          // ç¡®ä¿æ•°æ®å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›0
          return p.data[i] !== undefined ? p.data[i] : 0;
        }),
        itemStyle: { color: getColor(i) },
        label: { show: true, position: 'top', fontSize: 12 }
      }));

      // const option = {
      //   title: { text: document.getElementById('chartTitleInput').value, left:'center', top:10, textStyle:{fontSize:22,fontWeight:'bold'} },
      //   tooltip:{ trigger:'axis', axisPointer:{type:'shadow'} },
      //   legend:{ top:50, data:seriesNames },
      //   grid:{ left:'5%',right:'5%',bottom:'8%',containLabel:true },
      //   xAxis:{ type:'category', data:categories, axisLabel:{ fontSize:14 } },
      //   yAxis:{ type:'value', name:'äººæ•°ï¼ˆäººï¼‰', nameTextStyle:{fontSize:14} },
      //   series
      // };

      const option = {
        title: {
          text: document.getElementById('chartTitleInput').value,
          left: 'center', top: 10, textStyle: { fontSize: 22, fontWeight: 'bold' }
        },
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { top: 50, data: seriesNames },
        grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
        xAxis: {
          type: 'category',
          data: categories,
          axisLabel: {
            fontSize: 14,
            interval: 0,      // æ¯ä¸ªæ ‡ç­¾éƒ½æ˜¾ç¤º
            // rotate: 30       // Xè½´æ–‡å­—æ—‹è½¬30åº¦ï¼Œé˜²æ­¢é‡å 
          }
        },
        yAxis: { type: 'value', name: 'äººæ•°ï¼ˆäººï¼‰', nameTextStyle: { fontSize: 14 } },
        dataZoom: [
          { type: 'slider', show: true, xAxisIndex: 0, start: 0, end: 100 }, // æ¨ªå‘æ»šåŠ¨æ¡
          { type: 'inside', xAxisIndex: 0 } // æ”¯æŒé¼ æ ‡æ»šè½®/æ‹–åŠ¨ç¼©æ”¾
        ],
        series
      };

      myChart.setOption(option, true);
    }

    // åˆå§‹æ¸²æŸ“
    renderTableHead();
    renderTable();
    renderChart();
    window.addEventListener('resize', () => myChart.resize());

    // æ·»åŠ æ–°é¡¹ç›®
    document.getElementById('addProjectBtn').addEventListener('click', () => {
      // åˆ›å»ºä¸ç³»åˆ—æ•°é‡ç›¸åŒé•¿åº¦çš„æ•°æ®æ•°ç»„
      const newData = new Array(seriesNames.length).fill(0);
      projectData.push({ name: 'æ–°é¡¹ç›®', data: newData });
      renderTable();
    });

    // æ·»åŠ æ–°ç³»åˆ—
    document.getElementById('addSeriesBtn').addEventListener('click', () => {
      const newSeriesName = prompt('è¯·è¾“å…¥æ–°ç³»åˆ—åç§°ï¼ˆä¾‹å¦‚ï¼š2024ä¸åŠæ ¼ï¼‰:', '2024ä¸åŠæ ¼');
      if (newSeriesName && newSeriesName.trim()) {
        seriesNames.push(newSeriesName.trim());
        // ä¸ºæ‰€æœ‰ç°æœ‰é¡¹ç›®æ·»åŠ å¯¹åº”çš„æ•°æ®åˆ—ï¼ˆåˆå§‹å€¼ä¸º0ï¼‰
        projectData.forEach(proj => {
          proj.data.push(0);
        });
        renderTableHead();
        renderTable();
        renderChart();
      }
    });

    // åˆ·æ–°å›¾è¡¨
    document.getElementById('updateChartBtn').addEventListener('click', () => {
      // æ›´æ–°é¡¹ç›®åç§°
      document.querySelectorAll('.projName').forEach(input => {
        const idx = input.dataset.index;
        projectData[idx].name = input.value;
      });
      // æ›´æ–°æ•°æ®
      document.querySelectorAll('.projData').forEach(input => {
        const row = input.dataset.row;
        const col = input.dataset.col;
        projectData[row].data[col] = Number(input.value);
      });
      renderChart();
    });

    // å¯¼å‡ºå›¾ç‰‡
    document.getElementById('exportBtn').addEventListener('click', () => {
      const img = myChart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#ffffff' });
      const link = document.createElement('a');
      link.href = img;
      link.download = document.getElementById('chartTitleInput').value + '.png';
      link.click();
    });
  </script>

</body>

</html>